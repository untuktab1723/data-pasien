<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pasien - drg. Eka Pottimau</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-blue-50 min-h-screen font-sans">

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-sm mx-4 shadow-lg">
            <h2 class="text-2xl font-bold text-center mb-6">🔐 Login</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" placeholder="Masukkan username" required 
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" placeholder="Masukkan password" required 
                           class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                    Masuk
                </button>
            </form>
            <p class="text-center text-gray-500 mt-4">
                Username: admin<br>
                Password: 123456
            </p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">🦷 Sistem Pasien</h1>
            <p class="text-gray-600">drg. Eka Pottimau, M. Kes</p>
        </div>

        <!-- Navigation -->
        <div class="flex justify-center mb-6">
            <div class="bg-white rounded-lg p-1 shadow">
                <button id="patientsBtn" onclick="showView('patients')" 
                        class="px-4 py-2 rounded font-medium bg-blue-600 text-white">
                    👥 Daftar Pasien
                </button>
                <button id="addBtn" onclick="showView('add')" 
                        class="px-4 py-2 rounded font-medium text-gray-600">
                    ➕ Tambah Pasien
                </button>
            </div>
        </div>

        <!-- Patients View -->
        <div id="patientsView" class="bg-white rounded-xl shadow p-6">

            <!-- Search & Filter -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6">
                <input type="text" id="searchInput" placeholder="Cari pasien..." 
                       class="col-span-1 md:col-span-2 px-4 py-2 border rounded-lg" oninput="searchPatients()">
                <input type="date" id="filterFrom" class="px-4 py-2 border rounded-lg" onchange="filterByDate()">
                <input type="date" id="filterTo" class="px-4 py-2 border rounded-lg" onchange="filterByDate()">
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <div class="bg-blue-50 rounded-lg p-4 text-center">
                    <div class="text-xl font-bold text-blue-600" id="totalPatients">0</div>
                    <div class="text-sm text-blue-700">Total Pasien</div>
                </div>
                <div class="bg-green-50 rounded-lg p-4 text-center">
                    <div class="text-xl font-bold text-green-600" id="totalVisits">0</div>
                    <div class="text-sm text-green-700">Total Kunjungan</div>
                </div>
                <div class="bg-purple-50 rounded-lg p-4 text-center">
                    <div class="text-xl font-bold text-purple-600" id="todayVisits">0</div>
                    <div class="text-sm text-purple-700">Hari Ini</div>
                </div>
                <div class="bg-orange-50 rounded-lg p-4 text-center">
                    <div class="text-xl font-bold text-orange-600" id="thisMonthVisits">0</div>
                    <div class="text-sm text-orange-700">Bulan Ini</div>
                </div>
                <div class="bg-teal-50 rounded-lg p-4 text-center">
                    <div class="text-xl font-bold text-teal-600" id="thisYearVisits">0</div>
                    <div class="text-sm text-teal-700">Tahun Ini</div>
                </div>
            </div>

            <!-- New vs Returning -->
            <div class="grid grid-cols-2 gap-4 mb-6 bg-gray-50 p-4 rounded-lg">
                <div class="text-center">
                    <div class="font-bold text-green-600" id="newPatients">0</div>
                    <div class="text-sm text-gray-600">Pasien Baru</div>
                </div>
                <div class="text-center">
                    <div class="font-bold text-blue-600" id="returningPatients">0</div>
                    <div class="text-sm text-gray-600">Pasien Lama</div>
                </div>
            </div>

            <!-- Chart -->
            <div class="mb-6">
                <canvas id="visitChart" class="w-full h-64"></canvas>
            </div>

            <!-- Export Button -->
            <div class="mb-6 text-center">
                <button onclick="exportToExcel()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                    📥 Ekspor ke Excel
                </button>
            </div>

            <!-- Patients List -->
            <div id="patientsList"></div>
        </div>

        <!-- Add Patient View -->
        <div id="addView" class="bg-white rounded-xl shadow p-6 hidden">
            <h2 class="text-xl font-bold mb-4">➕ Tambah Pasien Baru</h2>
            <form id="addForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="name" placeholder="Nama Lengkap" required 
                           class="px-4 py-2 border rounded-lg">
                    <input type="tel" id="phone" placeholder="Nomor Telepon" required 
                           class="px-4 py-2 border rounded-lg">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="number" id="age" placeholder="Umur" required min="1" max="120"
                           class="px-4 py-2 border rounded-lg">
                    <select id="gender" required class="px-4 py-2 border rounded-lg">
                        <option value="">Pilih Jenis Kelamin</option>
                        <option value="Laki-laki">👨 Laki-laki</option>
                        <option value="Perempuan">👩 Perempuan</option>
                    </select>
                </div>
                <textarea id="address" placeholder="Alamat" required rows="2"
                          class="w-full px-4 py-2 border rounded-lg"></textarea>
                <textarea id="medicalHistory" placeholder="Riwayat Sakit Bawaan (diabetes, hipertensi, alergi obat, dll)" rows="2"
                          class="w-full px-4 py-2 border rounded-lg"></textarea>
                <textarea id="complaint" placeholder="Keluhan" required rows="2"
                          class="w-full px-4 py-2 border rounded-lg"></textarea>
                <textarea id="treatment" placeholder="Treatment/Tindakan" required rows="2"
                          class="w-full px-4 py-2 border rounded-lg"></textarea>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <textarea id="medication" placeholder="Obat (opsional)" rows="2"
                              class="px-4 py-2 border rounded-lg"></textarea>
                    <textarea id="notes" placeholder="Catatan (opsional)" rows="2"
                              class="px-4 py-2 border rounded-lg"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                    💾 Simpan Pasien
                </button>
                <button type="button" onclick="showView('patients')" 
                        class="w-full bg-gray-500 text-white py-2 rounded-lg">
                    Batal
                </button>
            </form>
        </div>

        <!-- Patient Modal -->
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 max-w-3xl mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold" id="modalName">Detail Pasien</h3>
                    <button onclick="closeModal()" class="text-gray-500 text-xl">×</button>
                </div>
                
                <div class="mb-4">
                    <p><strong>📞 Telepon:</strong> <span id="modalPhone"></span></p>
                    <p><strong>🎂 Umur:</strong> <span id="modalAge"></span> tahun</p>
                    <p><strong>👤 Jenis Kelamin:</strong> <span id="modalGender"></span></p>
                    <p><strong>📍 Alamat:</strong> <span id="modalAddress"></span></p>
                    <p><strong>🏥 Riwayat Sakit:</strong> <span id="modalMedicalHistory"></span></p>
                    <p><strong>Total Kunjungan:</strong> <span id="modalTotal"></span></p>
                </div>

                <!-- Add Visit Form -->
                <div class="mb-4 bg-blue-50 rounded-lg p-4">
                    <h4 class="font-bold mb-2">➕ Tambah Kunjungan</h4>
                    <form id="visitForm" class="space-y-3">
                        <textarea id="visitComplaint" placeholder="Keluhan" required rows="2"
                                  class="w-full px-3 py-2 border rounded"></textarea>
                        <textarea id="visitTreatment" placeholder="Treatment" required rows="2"
                                  class="w-full px-3 py-2 border rounded"></textarea>
                        <div class="grid grid-cols-2 gap-3">
                            <textarea id="visitMedication" placeholder="Obat" rows="2"
                                      class="px-3 py-2 border rounded"></textarea>
                            <textarea id="visitNotes" placeholder="Catatan" rows="2"
                                      class="px-3 py-2 border rounded"></textarea>
                        </div>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            💾 Simpan Kunjungan
                        </button>
                    </form>
                </div>

                <!-- Visit History -->
                <div>
                    <h4 class="font-bold mb-2">📋 Riwayat Kunjungan</h4>
                    <div id="visitHistory" class="space-y-2 max-h-40 overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <!-- Delete Modal -->
        <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 max-w-md mx-4">
                <div class="text-center">
                    <div class="text-4xl mb-2">⚠️</div>
                    <h3 class="text-lg font-bold mb-2">Hapus Pasien?</h3>
                    <p class="text-gray-600 mb-4" id="deleteName"></p>
                    <div class="flex gap-3 justify-center">
                        <button onclick="closeDeleteModal()" class="bg-gray-500 text-white px-4 py-2 rounded">
                            Batal
                        </button>
                        <button onclick="confirmDelete()" class="bg-red-600 text-white px-4 py-2 rounded">
                            🗑️ Hapus
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === LOGIN ===
        const loginForm = document.getElementById('loginForm');
        const loginModal = document.getElementById('loginModal');
        const app = document.getElementById('app');

        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === 'admin' && password === '123456') {
                loginModal.classList.add('hidden');
                app.classList.remove('hidden');
                init();
            } else {
                alert('Username atau password salah!');
            }
        });

        // === DATA ===
        let patients = JSON.parse(localStorage.getItem('dentalPatients')) || [
            {
                id: 1,
                name: "Sari Wijaya",
                phone: "081234567890",
                age: 35,
                gender: "👩 Perempuan",
                address: "Jl. Merdeka No. 15, Ambon",
                medicalHistory: "Diabetes tipe 2, alergi penisilin",
                visits: [
                    { date: "2024-01-15", complaint: "Sakit gigi", treatment: "Tambal", medication: "Asam Mefenamat", notes: "" }
                ]
            },
            {
                id: 2,
                name: "Ahmad Rizki",
                phone: "082345678901",
                age: 28,
                gender: "👨 Laki-laki",
                address: "Jl. Pattimura No. 23, Ambon",
                medicalHistory: "",
                visits: [
                    { date: "2024-01-12", complaint: "Gigi berlubang", treatment: "Tambal resin", medication: "", notes: "" }
                ]
            }
        ];

        function savePatients() {
            localStorage.setItem('dentalPatients', JSON.stringify(patients));
        }

        // === INIT ===
        function init() {
            displayPatients();
            updateStats();
            initChart();
        }

        // === NAVIGATION ===
        function showView(view) {
            document.getElementById('patientsView').classList.toggle('hidden', view !== 'patients');
            document.getElementById('addView').classList.toggle('hidden', view !== 'add');
            
            document.getElementById('patientsBtn').className = view === 'patients' 
                ? 'px-4 py-2 rounded font-medium bg-blue-600 text-white'
                : 'px-4 py-2 rounded font-medium text-gray-600';
            document.getElementById('addBtn').className = view === 'add' 
                ? 'px-4 py-2 rounded font-medium bg-blue-600 text-white'
                : 'px-4 py-2 rounded font-medium text-gray-600';
        }

        // === DISPLAY ===
        function displayPatients(filtered = null) {
            const list = document.getElementById('patientsList');
            const patientsToShow = filtered || patients;
            
            if (patientsToShow.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 py-4">Tidak ada pasien</p>';
                return;
            }

            list.innerHTML = patientsToShow.map(patient => `
                <div class="border rounded-lg p-4 mb-3 hover:shadow-md">
                    <div class="flex justify-between items-start">
                        <div class="cursor-pointer flex-1" onclick="openModal(${patient.id})">
                            <h3 class="font-bold text-lg">${patient.name}</h3>
                            <p class="text-gray-600">📞 ${patient.phone} • 🎂 ${patient.age} tahun • ${patient.gender}</p>
                            <p class="text-gray-600">📍 ${patient.address}</p>
                            ${patient.medicalHistory ? `<p class="text-orange-600 text-sm">🏥 ${patient.medicalHistory}</p>` : ''}
                            <p class="text-sm text-blue-600">${patient.visits.length} kunjungan</p>
                        </div>
                        <button onclick="deletePatient(${patient.id})" 
                                class="text-red-600 hover:bg-red-50 p-2 rounded">
                            🗑️
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function searchPatients() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            if (!term) return displayPatients();
            const filtered = patients.filter(p => 
                p.name.toLowerCase().includes(term) || p.phone.includes(term)
            );
            displayPatients(filtered);
        }

        function filterByDate() {
            const from = document.getElementById('filterFrom').value;
            const to = document.getElementById('filterTo').value;
            if (!from || !to) return displayPatients();

            const filtered = patients.filter(p =>
                p.visits.some(v => v.date >= from && v.date <= to)
            );
            displayPatients(filtered);
        }

        // === STATS ===
        function updateStats() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const currentMonth = today.slice(0, 7);
            const currentYear = now.getFullYear();

            let todayCount = 0, monthCount = 0, yearCount = 0;
            let newPatientCount = 0, returningPatientCount = 0;

            patients.forEach(p => {
                p.visits.forEach(v => {
                    if (v.date === today) todayCount++;
                    if (v.date.startsWith(currentMonth)) monthCount++;
                    if (new Date(v.date).getFullYear() === currentYear) yearCount++;
                });

                const firstVisit = new Date(p.visits[0].date);
                if (firstVisit >= new Date(now.getFullYear(), now.getMonth() - 1)) {
                    newPatientCount++;
                } else {
                    returningPatientCount++;
                }
            });

            document.getElementById('totalPatients').textContent = patients.length;
            document.getElementById('totalVisits').textContent = patients.reduce((a, p) => a + p.visits.length, 0);
            document.getElementById('todayVisits').textContent = todayCount;
            document.getElementById('thisMonthVisits').textContent = monthCount;
            document.getElementById('thisYearVisits').textContent = yearCount;
            document.getElementById('newPatients').textContent = newPatientCount;
            document.getElementById('returningPatients').textContent = returningPatientCount;

            updateChart();
        }

        // === CHART ===
        let visitChart = null;
        function initChart() {
            const ctx = document.getElementById('visitChart').getContext('2d');
            const labels = Array.from({length: 7}, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - 6 + i);
                return d.toISOString().split('T')[0];
            });

            visitChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Kunjungan Harian',
                        data: labels.map(date => 
                            patients.reduce((sum, p) => sum + p.visits.filter(v => v.date === date).length, 0)
                        ),
                        backgroundColor: 'rgba(59, 130, 246, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function updateChart() {
            const labels = visitChart.data.labels;
            visitChart.data.datasets[0].data = labels.map(date => 
                patients.reduce((sum, p) => sum + p.visits.filter(v => v.date === date).length, 0)
            );
            visitChart.update();
        }

        // === ADD PATIENT ===
        document.getElementById('addForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newPatient = {
                id: Date.now(),
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                age: parseInt(document.getElementById('age').value),
                gender: document.getElementById('gender').value,
                address: document.getElementById('address').value,
                medicalHistory: document.getElementById('medicalHistory').value,
                visits: [{
                    date: new Date().toISOString().split('T')[0],
                    complaint: document.getElementById('complaint').value,
                    treatment: document.getElementById('treatment').value,
                    medication: document.getElementById('medication').value,
                    notes: document.getElementById('notes').value
                }]
            };

            patients.unshift(newPatient);
            this.reset();
            showView('patients');
            displayPatients();
            updateStats();
            savePatients();
        });

        // === MODAL ===
        function openModal(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;

            currentPatientId = patientId;
            document.getElementById('modalName').textContent = patient.name;
            document.getElementById('modalPhone').textContent = patient.phone;
            document.getElementById('modalAge').textContent = patient.age;
            document.getElementById('modalGender').textContent = patient.gender;
            document.getElementById('modalAddress').textContent = patient.address;
            document.getElementById('modalMedicalHistory').textContent = patient.medicalHistory || 'Tidak ada riwayat sakit';
            document.getElementById('modalTotal').textContent = patient.visits.length;
            
            displayVisitHistory(patient.visits);
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').classList.add('flex');
        }

        function displayVisitHistory(visits) {
            const history = document.getElementById('visitHistory');
            if (visits.length === 0) {
                history.innerHTML = '<p class="text-gray-500">Belum ada kunjungan</p>';
                return;
            }

            history.innerHTML = visits.map(visit => `
                <div class="bg-gray-50 rounded p-3 text-sm">
                    <p><strong>📅 ${visit.date}</strong></p>
                    <p><strong>Keluhan:</strong> ${visit.complaint}</p>
                    <p><strong>Treatment:</strong> ${visit.treatment}</p>
                    ${visit.medication ? `<p><strong>💊 Obat:</strong> ${visit.medication}</p>` : ''}
                    ${visit.notes ? `<p><strong>📝 Catatan:</strong> ${visit.notes}</p>` : ''}
                </div>
            `).join('');
        }

        document.getElementById('visitForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const patient = patients.find(p => p.id === currentPatientId);
            if (!patient) return;

            const newVisit = {
                date: new Date().toISOString().split('T')[0],
                complaint: document.getElementById('visitComplaint').value,
                treatment: document.getElementById('visitTreatment').value,
                medication: document.getElementById('visitMedication').value,
                notes: document.getElementById('visitNotes').value
            };

            patient.visits.unshift(newVisit);
            document.getElementById('modalTotal').textContent = patient.visits.length;
            displayVisitHistory(patient.visits);
            this.reset();
            displayPatients();
            updateStats();
            savePatients();
        });

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
        }

        // === DELETE ===
        function deletePatient(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;
            
            deletePatientId = patientId;
            document.getElementById('deleteName').textContent = patient.name;
            document.getElementById('deleteModal').classList.remove('hidden');
            document.getElementById('deleteModal').classList.add('flex');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
            document.getElementById('deleteModal').classList.remove('flex');
        }

        function confirmDelete() {
            const index = patients.findIndex(p => p.id === deletePatientId);
            if (index !== -1) {
                patients.splice(index, 1);
                displayPatients();
                updateStats();
                savePatients();
            }
            closeDeleteModal();
        }

        // === EXPORT TO EXCEL ===
        function exportToExcel() {
            const data = [];
            patients.forEach(p => {
                p.visits.forEach(v => {
                    data.push({
                        "Nama": p.name,
                        "Telepon": p.phone,
                        "Umur": p.age,
                        "Jenis Kelamin": p.gender,
                        "Alamat": p.address,
                        "Riwayat Sakit": p.medicalHistory,
                        "Tanggal Kunjungan": v.date,
                        "Keluhan": v.complaint,
                        "Treatment": v.treatment,
                        "Obat": v.medication,
                        "Catatan": v.notes
                    });
                });
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data Pasien");
            XLSX.writeFile(wb, `Laporan_Pasien_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        // === CLOSE MODALS ===
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) closeDeleteModal();
        });
    </script>
</body>
</html>